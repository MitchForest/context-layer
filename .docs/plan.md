# Context Layer Implementation Plan

## Vision

A self-updating documentation system that maintains hierarchical `AGENTS.md` files throughout a codebase. Zero manual maintenance required after initial setup.

---

## Architecture Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           CONTEXT LAYER                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚    CODEMAP     â”‚   â”‚    CURATOR     â”‚   â”‚     SYNTHESIZER        â”‚   â”‚
â”‚  â”‚    (Script)    â”‚   â”‚    (LLM)       â”‚   â”‚     (LLM)              â”‚   â”‚
â”‚  â”‚                â”‚   â”‚                â”‚   â”‚                        â”‚   â”‚
â”‚  â”‚  tree-sitter   â”‚   â”‚  Haiku/Opus    â”‚   â”‚  Opus (periodic)       â”‚   â”‚
â”‚  â”‚  instant/free  â”‚   â”‚  on change     â”‚   â”‚  deduplication         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚          â”‚                    â”‚                       â”‚                  â”‚
â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                               â”‚                                          â”‚
â”‚                               â–¼                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                         MANIFEST                                  â”‚   â”‚
â”‚  â”‚  .context-layer/manifest.json                                    â”‚   â”‚
â”‚  â”‚  - All systems & status                                          â”‚   â”‚
â”‚  â”‚  - Timestamps (codemap, curator, synthesis)                      â”‚   â”‚
â”‚  â”‚  - Pending new systems                                           â”‚   â”‚
â”‚  â”‚  - Hierarchy                                                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Components

### 1. CLI Tool (`context-layer`)

Node.js CLI that handles:
- Codemap generation (tree-sitter)
- Change analysis
- Manifest management
- Git hook installation

### 2. Agents (Claude Code)

| Agent | Purpose | Model | Parallelism |
|-------|---------|-------|-------------|
| **Coordinator** | Orchestrates builds, spawns agents | Inherited | Sequential |
| **Capture** | Creates AGENTS.md for one system | Inherited | Parallel (batch of 5) |
| **Maintain** | Updates curated content after changes | Haiku | Parallel per system |
| **Synthesis** | Deduplicates, creates parent nodes | Opus | Sequential (needs all) |

### 3. AGENTS.md Format

```markdown
# System Name

<!-- CODEMAP START - Auto-generated by tree-sitter -->
## API Surface

### file.ts
- `function doThing(arg: Type): ReturnType`
- `class MyClass { ... }`
<!-- CODEMAP END -->

---

## Ownership

**Owns**: [curated by LLM]
**Does NOT own**: [curated by LLM]

## Invariants

- [curated by LLM]

## Patterns

[curated by LLM]
```

---

## Implementation Phases

### Phase 0: Foundation âœ…
- [x] Basic agents (coordinator, capture, maintain, synthesis)
- [x] Install script for agents
- [x] Root-level manifest
- [x] Smart file reading (batched)

### Phase 1: CLI Tool âœ…
- [x] Create `packages/cli/` directory structure
- [x] Set up Node.js package with TypeScript
- [x] Implement `context-layer codemap` command
  - [x] Integrate web-tree-sitter (WASM) for TypeScript/TSX
  - [x] Integrate web-tree-sitter for Python
  - [x] Integrate web-tree-sitter for Swift
  - [x] Generate codemap markdown section
- [x] Implement `context-layer analyze` command
  - [x] Detect new systems (heuristics-based)
  - [x] Detect deleted systems
  - [x] Categorize change size (none/minor/major)
- [x] Implement manifest management
  - [x] Read/write manifest.json
  - [x] Track system status
  - [x] Track pending new systems
- [x] Implement `context-layer status` command
- [ ] Publish to npm as `@context-layer/cli` (pending)

### Phase 2: Git Hook âœ…
- [x] Create git hook script (in `init` command)
- [x] Step 1: Run `context-layer codemap --changed`
- [x] Step 2: Run `context-layer analyze`
- [x] Step 3: Suggest Haiku/Opus based on change type
- [x] Update install script to install hook

### Phase 3: Agent Updates âœ…
- [x] Update AGENTS.md format to include codemap markers
- [x] Update Capture agent
  - [x] Call CLI for codemap generation
  - [x] Include codemap in AGENTS.md output
  - [x] Document format with HTML comment markers
- [x] Update Maintain agent
  - [x] Only touch curated sections
  - [x] Preserve codemap markers (auto-updated by CLI)
- [x] Update Synthesis agent
  - [x] Preserve codemap sections when deduplicating
- [x] Update Coordinator agent with CLI integration notes

### Phase 4: Auto-Maintenance âœ…
- [x] Git hook auto-runs Haiku for maintenance (no manual intervention)
- [x] User can override model via CONTEXT_LAYER_MODEL env var
- [x] Skill file updated to document automatic maintenance
- [ ] CI/CD examples (optional, can add later)

### Phase 5: Polish âœ…
- [x] Update README with CLI and workflow documentation
- [x] Dry-run mode in codemap command
- [ ] Publish CLI to npm
- [ ] Push to GitHub

---

## Detailed Implementation

### CLI Package Structure

```
packages/cli/
â”œâ”€â”€ package.json
â”œâ”€â”€ tsconfig.json
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ index.ts              # CLI entry point
â”‚   â”œâ”€â”€ commands/
â”‚   â”‚   â”œâ”€â”€ codemap.ts        # Generate codemaps
â”‚   â”‚   â”œâ”€â”€ analyze.ts        # Analyze changes
â”‚   â”‚   â”œâ”€â”€ status.ts         # Show status
â”‚   â”‚   â”œâ”€â”€ init.ts           # Initial setup
â”‚   â”‚   â””â”€â”€ build-pending.ts  # Process queued systems
â”‚   â”œâ”€â”€ codemap/
â”‚   â”‚   â”œâ”€â”€ generator.ts      # Main codemap logic
â”‚   â”‚   â”œâ”€â”€ parsers/
â”‚   â”‚   â”‚   â”œâ”€â”€ typescript.ts # tree-sitter-typescript
â”‚   â”‚   â”‚   â”œâ”€â”€ swift.ts      # tree-sitter-swift
â”‚   â”‚   â”‚   â””â”€â”€ python.ts     # tree-sitter-python
â”‚   â”‚   â””â”€â”€ formatter.ts      # Format as markdown
â”‚   â”œâ”€â”€ analyzer/
â”‚   â”‚   â”œâ”€â”€ changes.ts        # Detect change types
â”‚   â”‚   â”œâ”€â”€ systems.ts        # Detect new systems
â”‚   â”‚   â””â”€â”€ heuristics.ts     # Is this a "system"?
â”‚   â”œâ”€â”€ manifest/
â”‚   â”‚   â”œâ”€â”€ schema.ts         # TypeScript types
â”‚   â”‚   â”œâ”€â”€ read.ts           # Load manifest
â”‚   â”‚   â””â”€â”€ write.ts          # Save manifest
â”‚   â””â”€â”€ utils/
â”‚       â”œâ”€â”€ git.ts            # Git helpers
â”‚       â””â”€â”€ files.ts          # File system helpers
â””â”€â”€ bin/
    â””â”€â”€ context-layer         # CLI binary
```

### Git Hook Flow

```bash
#!/bin/bash
# .git/hooks/post-commit
# Auto-maintains context layer on every commit

set -e

echo "ğŸ§  Context Layer: Processing commit..."

if command -v context-layer &> /dev/null; then
  # Step 1: Update codemaps (instant, free)
  context-layer codemap --changed --quiet
  
  # Step 2: Analyze changes
  ANALYSIS=$(context-layer analyze --json 2>/dev/null || echo '{"changeType":"none"}')
  CHANGE_TYPE=$(echo "$ANALYSIS" | grep -o '"changeType":"[^"]*"' | cut -d'"' -f4)
  
  # Model: default haiku, override with CONTEXT_LAYER_MODEL env var
  MODEL=${CONTEXT_LAYER_MODEL:-haiku}
  
  # Step 3: Auto-run maintenance if changes detected
  case $CHANGE_TYPE in
    "none")
      echo "   âœ“ Codemaps updated, no curated content changes needed"
      ;;
    "minor"|"major")
      echo "   â†’ Changes detected, updating curated content with $MODEL..."
      claude -p "Maintain context layer" --model $MODEL --allowedTools "Read,Write,Bash"
      ;;
  esac
fi
```

### Parallel vs Sequential Execution

```
INITIAL BUILD
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                    â”‚ Capture â”‚
                                    â”‚ System1 â”‚
                                    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Coordinator â”‚â”€â”€â–¶â”‚  Discovery  â”‚â”€â”€â–¶ (parallel)â”€â”€â–¶â”‚  Synthesis  â”‚
â”‚  (Opus)     â”‚   â”‚  (Script)   â”‚        â”‚        â”‚  (Opus)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚ Capture â”‚
                                    â”‚ System2 â”‚
                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    
                     Sequential â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ Sequential
                                     Parallel
                                   (batch of 5)


AUTO-MAINTENANCE (per commit) - FULLY AUTOMATED
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Codemap  â”‚â”€â”€â–¶â”‚ Analyze â”‚â”€â”€â–¶â”‚ Haiku Maintains â”‚
â”‚ (CLI)    â”‚   â”‚ (CLI)   â”‚   â”‚ (auto-runs)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚              â”‚                 â”‚
     â”‚              â”‚                 â””â”€â”€ Updates curated content in AGENTS.md
     â”‚              â””â”€â”€ Determines if changes affect docs
     â””â”€â”€ Updates API surface (tree-sitter, free)

No manual intervention. Context layer stays in sync with code.
```

### System Detection Heuristics

```typescript
interface SystemCandidate {
  path: string;
  score: number;
  reasons: string[];
}

function evaluateAsSystem(dir: string): SystemCandidate | null {
  const files = getSourceFiles(dir);
  const score = 0;
  const reasons = [];
  
  // Must have minimum files
  if (files.length < 3) return null;
  
  // Scoring
  if (files.length >= 5) { score += 2; reasons.push('5+ source files'); }
  if (hasEntryPoint(files)) { score += 3; reasons.push('has entry point'); }
  if (hasServicePattern(files)) { score += 2; reasons.push('Service/Manager/Engine pattern'); }
  if (hasReadme(dir)) { score += 1; reasons.push('has README'); }
  if (files.some(f => f.includes('index') || f.includes('mod'))) { score += 1; }
  
  // Disqualifiers
  if (dir.includes('test')) return null;
  if (dir.includes('__generated__')) return null;
  if (dir.includes('node_modules')) return null;
  if (dir.includes('.git')) return null;
  
  // Threshold
  if (score < 3) return null;
  
  return { path: dir, score, reasons };
}
```

### Manifest Schema

```typescript
interface Manifest {
  version: "1.0";
  repo: string;
  
  // Timestamps
  created: string;
  lastFullBuild: string;
  lastSynthesis: string;
  
  // Coverage
  coverage: {
    totalDirectories: number;
    documentedSystems: number;
    percentage: number;
  };
  
  // All documented systems
  systems: {
    [path: string]: {
      agentsMdPath: string;
      status: 'active' | 'stale' | 'pending_deletion';
      fileCount: number;
      codemapUpdated: string;
      curatorUpdated: string;
      tokens: number;
    };
  };
  
  // Systems waiting to be documented
  pending: {
    path: string;
    detectedAt: string;
    reason: string;
    score: number;
  }[];
  
  // Parent-child relationships
  hierarchy: {
    [parentPath: string]: string[];  // parent -> children
  };
  
  // Synthesis tracking
  synthesis: {
    lastRun: string;
    factsDeduped: number;
    parentNodesCreated: number;
  };
}
```

---

## Testing Plan

### Unit Tests
- [ ] Codemap generator (each language parser)
- [ ] Change analyzer (various scenarios)
- [ ] System detection heuristics
- [ ] Manifest read/write

### Integration Tests
- [ ] Full build on sample repo
- [ ] Incremental update after changes
- [ ] New system detection
- [ ] Synthesis deduplication

### E2E Tests
- [ ] Install script
- [ ] Git hook flow
- [ ] Claude integration (mock or real)

---

## Migration Path

For repos with existing AGENTS.md files:

1. `context-layer init --existing`
   - Detects existing AGENTS.md files
   - Adds codemap markers
   - Creates manifest from existing structure
   - Preserves all curated content

2. First synthesis
   - Validates hierarchy
   - Checks for duplicates
   - Suggests cleanup

---

## Open Questions

1. **Nightly synthesis**: How to trigger? Cron job? GitHub Action schedule?
2. **Cost controls**: Max tokens per commit? Budget alerts?
3. **Multi-language repos**: Priority for which parsers to build first?
4. **Monorepo support**: Multiple manifests or one global?
5. **Conflict resolution**: What if manual edit conflicts with auto-update?

---

## Success Metrics

- **Zero manual maintenance calls** after initial setup
- **< 5 second** codemap update per commit
- **< $2/month** LLM costs for active repo
- **> 90% coverage** of significant systems
- **< 1 day staleness** for curated content after changes

---

## Timeline Estimate

| Phase | Effort | Dependencies |
|-------|--------|--------------|
| Phase 0 (current) | Done | - |
| Phase 1 (CLI) | 8-12 hours | - |
| Phase 2 (Git Hook) | 2-3 hours | Phase 1 |
| Phase 3 (Agent Updates) | 4-6 hours | Phase 1 |
| Phase 4 (Auto-maintenance) | 3-4 hours | Phase 2, 3 |
| Phase 5 (Polish) | 4-6 hours | Phase 4 |

**Total: ~25-35 hours**

---

## Next Steps

1. Push all changes to GitHub
2. Publish CLI to npm as `@context-layer/cli`
3. Test end-to-end flow on a fresh repo
4. Add Swift WASM support when available
5. Consider adding CI/CD examples (GitHub Actions)

