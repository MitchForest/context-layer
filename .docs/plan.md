# Context Layer Implementation Plan

## Vision

A self-updating documentation system that maintains hierarchical `AGENTS.md` files throughout a codebase. Zero manual maintenance required after initial setup.

---

## Architecture Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           CONTEXT LAYER                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚    CODEMAP     â”‚   â”‚    CURATOR     â”‚   â”‚     SYNTHESIZER        â”‚   â”‚
â”‚  â”‚    (Script)    â”‚   â”‚    (LLM)       â”‚   â”‚     (LLM)              â”‚   â”‚
â”‚  â”‚                â”‚   â”‚                â”‚   â”‚                        â”‚   â”‚
â”‚  â”‚  tree-sitter   â”‚   â”‚  Haiku/Opus    â”‚   â”‚  Opus (periodic)       â”‚   â”‚
â”‚  â”‚  instant/free  â”‚   â”‚  on change     â”‚   â”‚  deduplication         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚          â”‚                    â”‚                       â”‚                  â”‚
â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                               â”‚                                          â”‚
â”‚                               â–¼                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                         MANIFEST                                  â”‚   â”‚
â”‚  â”‚  .context-layer/manifest.json                                    â”‚   â”‚
â”‚  â”‚  - All systems & status                                          â”‚   â”‚
â”‚  â”‚  - Timestamps (codemap, curator, synthesis)                      â”‚   â”‚
â”‚  â”‚  - Pending new systems                                           â”‚   â”‚
â”‚  â”‚  - Hierarchy                                                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Components

### 1. CLI Tool (`context-layer`)

Node.js CLI that handles:
- Codemap generation (tree-sitter)
- Change analysis
- Manifest management
- Git hook installation

### 2. Agents (Claude Code)

| Agent | Purpose | Model | Parallelism |
|-------|---------|-------|-------------|
| **Coordinator** | Orchestrates builds, spawns agents | Inherited | Sequential |
| **Capture** | Creates AGENTS.md for one system | Inherited | Parallel (batch of 5) |
| **Maintain** | Updates curated content after changes | Haiku | Parallel per system |
| **Synthesis** | Deduplicates, creates parent nodes | Opus | Sequential (needs all) |

### 3. AGENTS.md Format

```markdown
# System Name

<!-- CODEMAP START - Auto-generated by tree-sitter -->
## API Surface

### file.ts
- `function doThing(arg: Type): ReturnType`
- `class MyClass { ... }`
<!-- CODEMAP END -->

---

## Ownership

**Owns**: [curated by LLM]
**Does NOT own**: [curated by LLM]

## Invariants

- [curated by LLM]

## Patterns

[curated by LLM]
```

---

## Implementation Phases

### Phase 0: Foundation (Current State)
- [x] Basic agents (coordinator, capture, maintain, synthesis)
- [x] Install script for agents
- [x] Root-level manifest
- [x] Smart file reading (batched)
- [ ] Push current changes to GitHub

### Phase 1: CLI Tool
- [ ] Create `packages/cli/` directory structure
- [ ] Set up Node.js package with TypeScript
- [ ] Implement `context-layer codemap` command
  - [ ] Integrate tree-sitter for TypeScript
  - [ ] Integrate tree-sitter for Swift
  - [ ] Integrate tree-sitter for Python
  - [ ] Generate codemap markdown section
- [ ] Implement `context-layer analyze` command
  - [ ] Detect new systems (3+ files, no AGENTS.md)
  - [ ] Detect deleted systems
  - [ ] Categorize change size (none/minor/major)
- [ ] Implement manifest management
  - [ ] Read/write manifest.json
  - [ ] Track system status
  - [ ] Track pending new systems
- [ ] Implement `context-layer status` command
- [ ] Publish to npm as `@context-layer/cli`

### Phase 2: Git Hook
- [ ] Create git hook script
- [ ] Step 1: Run `context-layer codemap --changed`
- [ ] Step 2: Run `context-layer analyze`
- [ ] Step 3: Conditionally call Claude (Haiku/Opus)
- [ ] Step 4: Queue new systems
- [ ] Step 5: Check if synthesis needed
- [ ] Update install script to install hook

### Phase 3: Agent Updates
- [ ] Update AGENTS.md format to include codemap markers
- [ ] Update Capture agent
  - [ ] Accept codemap as input (from CLI)
  - [ ] Focus on curated sections only
  - [ ] Output format with codemap markers
- [ ] Update Maintain agent
  - [ ] Only touch curated sections
  - [ ] Preserve codemap markers
  - [ ] Detect when to escalate to Opus
- [ ] Update Synthesis agent
  - [ ] Preserve codemap sections when deduplicating
  - [ ] Update hierarchy in manifest
- [ ] Create Curator agent (new, for auto-maintenance)
  - [ ] Lightweight check: is curated content still valid?
  - [ ] Flag for Opus if confidence low

### Phase 4: Auto-Maintenance
- [ ] Implement nightly/weekly synthesis schedule
- [ ] Implement `context-layer build-pending` command
- [ ] Add CI/CD examples (GitHub Actions, GitLab CI)
- [ ] Test full auto-update flow

### Phase 5: Polish
- [ ] Comprehensive error handling
- [ ] Progress output during builds
- [ ] Dry-run mode
- [ ] Verbose/debug mode
- [ ] Update README with new workflow
- [ ] Add examples for common scenarios

---

## Detailed Implementation

### CLI Package Structure

```
packages/cli/
â”œâ”€â”€ package.json
â”œâ”€â”€ tsconfig.json
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ index.ts              # CLI entry point
â”‚   â”œâ”€â”€ commands/
â”‚   â”‚   â”œâ”€â”€ codemap.ts        # Generate codemaps
â”‚   â”‚   â”œâ”€â”€ analyze.ts        # Analyze changes
â”‚   â”‚   â”œâ”€â”€ status.ts         # Show status
â”‚   â”‚   â”œâ”€â”€ init.ts           # Initial setup
â”‚   â”‚   â””â”€â”€ build-pending.ts  # Process queued systems
â”‚   â”œâ”€â”€ codemap/
â”‚   â”‚   â”œâ”€â”€ generator.ts      # Main codemap logic
â”‚   â”‚   â”œâ”€â”€ parsers/
â”‚   â”‚   â”‚   â”œâ”€â”€ typescript.ts # tree-sitter-typescript
â”‚   â”‚   â”‚   â”œâ”€â”€ swift.ts      # tree-sitter-swift
â”‚   â”‚   â”‚   â””â”€â”€ python.ts     # tree-sitter-python
â”‚   â”‚   â””â”€â”€ formatter.ts      # Format as markdown
â”‚   â”œâ”€â”€ analyzer/
â”‚   â”‚   â”œâ”€â”€ changes.ts        # Detect change types
â”‚   â”‚   â”œâ”€â”€ systems.ts        # Detect new systems
â”‚   â”‚   â””â”€â”€ heuristics.ts     # Is this a "system"?
â”‚   â”œâ”€â”€ manifest/
â”‚   â”‚   â”œâ”€â”€ schema.ts         # TypeScript types
â”‚   â”‚   â”œâ”€â”€ read.ts           # Load manifest
â”‚   â”‚   â””â”€â”€ write.ts          # Save manifest
â”‚   â””â”€â”€ utils/
â”‚       â”œâ”€â”€ git.ts            # Git helpers
â”‚       â””â”€â”€ files.ts          # File system helpers
â””â”€â”€ bin/
    â””â”€â”€ context-layer         # CLI binary
```

### Git Hook Flow

```bash
#!/bin/bash
# .git/hooks/post-commit

# Exit on error
set -e

# Step 1: Update codemaps (instant, free)
echo "ğŸ§  Context Layer: Updating codemaps..."
context-layer codemap --changed --quiet

# Step 2: Analyze what changed
ANALYSIS=$(context-layer analyze --json)
CHANGE_TYPE=$(echo $ANALYSIS | jq -r '.changeType')
NEW_SYSTEMS=$(echo $ANALYSIS | jq -r '.newSystems[]?')

# Step 3: Handle based on change type
case $CHANGE_TYPE in
  "none")
    echo "   âœ“ No doc updates needed"
    ;;
    
  "minor")
    echo "   â†’ Minor changes, checking with Haiku..."
    claude -p "The codemap sections in AGENTS.md files have been updated. Check if any curated sections need minor updates. Only change if clearly outdated." \
      --allowedTools "Read,Write" \
      --model haiku \
      --max-turns 5
    ;;
    
  "major")
    echo "   â†’ Major changes, reviewing with Opus..."
    claude -p "Significant code changes detected. Review and update AGENTS.md curated sections. Codemaps already updated." \
      --allowedTools "Read,Write" \
      --model opus \
      --max-turns 10
    ;;
esac

# Step 4: Queue new systems
if [ -n "$NEW_SYSTEMS" ]; then
  echo "   ğŸ“ New systems detected:"
  for sys in $NEW_SYSTEMS; do
    echo "      - $sys"
    context-layer queue "$sys"
  done
  echo "   â†’ Run 'context-layer build-pending' to create docs"
fi

# Step 5: Check if synthesis needed
DAYS_SINCE_SYNTHESIS=$(context-layer days-since-synthesis)
PENDING_COUNT=$(context-layer pending-count)

if [ "$PENDING_COUNT" -gt 0 ] || [ "$DAYS_SINCE_SYNTHESIS" -gt 7 ]; then
  echo "   â†’ Synthesis recommended (run 'context-layer synthesize')"
fi

echo "âœ“ Context Layer updated"
```

### Parallel vs Sequential Execution

```
INITIAL BUILD
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                    â”‚ Capture â”‚
                                    â”‚ System1 â”‚
                                    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Coordinator â”‚â”€â”€â–¶â”‚  Discovery  â”‚â”€â”€â–¶ (parallel)â”€â”€â–¶â”‚  Synthesis  â”‚
â”‚  (Opus)     â”‚   â”‚  (Script)   â”‚        â”‚        â”‚  (Opus)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚ Capture â”‚
                                    â”‚ System2 â”‚
                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    
                     Sequential â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ Sequential
                                     Parallel
                                   (batch of 5)


AUTO-MAINTENANCE (per commit)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Codemap  â”‚â”€â”€â–¶â”‚ Analyze â”‚â”€â”€â–¶â”‚ Curator â”‚â”€â”€â–¶â”‚ Synthesis â”‚
â”‚ (Script) â”‚   â”‚ (Script)â”‚   â”‚ (Haiku) â”‚   â”‚ (weekly)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

All sequential per commit (fast path)
Synthesis only runs weekly or when new systems added
```

### System Detection Heuristics

```typescript
interface SystemCandidate {
  path: string;
  score: number;
  reasons: string[];
}

function evaluateAsSystem(dir: string): SystemCandidate | null {
  const files = getSourceFiles(dir);
  const score = 0;
  const reasons = [];
  
  // Must have minimum files
  if (files.length < 3) return null;
  
  // Scoring
  if (files.length >= 5) { score += 2; reasons.push('5+ source files'); }
  if (hasEntryPoint(files)) { score += 3; reasons.push('has entry point'); }
  if (hasServicePattern(files)) { score += 2; reasons.push('Service/Manager/Engine pattern'); }
  if (hasReadme(dir)) { score += 1; reasons.push('has README'); }
  if (files.some(f => f.includes('index') || f.includes('mod'))) { score += 1; }
  
  // Disqualifiers
  if (dir.includes('test')) return null;
  if (dir.includes('__generated__')) return null;
  if (dir.includes('node_modules')) return null;
  if (dir.includes('.git')) return null;
  
  // Threshold
  if (score < 3) return null;
  
  return { path: dir, score, reasons };
}
```

### Manifest Schema

```typescript
interface Manifest {
  version: "1.0";
  repo: string;
  
  // Timestamps
  created: string;
  lastFullBuild: string;
  lastSynthesis: string;
  
  // Coverage
  coverage: {
    totalDirectories: number;
    documentedSystems: number;
    percentage: number;
  };
  
  // All documented systems
  systems: {
    [path: string]: {
      agentsMdPath: string;
      status: 'active' | 'stale' | 'pending_deletion';
      fileCount: number;
      codemapUpdated: string;
      curatorUpdated: string;
      tokens: number;
    };
  };
  
  // Systems waiting to be documented
  pending: {
    path: string;
    detectedAt: string;
    reason: string;
    score: number;
  }[];
  
  // Parent-child relationships
  hierarchy: {
    [parentPath: string]: string[];  // parent -> children
  };
  
  // Synthesis tracking
  synthesis: {
    lastRun: string;
    factsDeduped: number;
    parentNodesCreated: number;
  };
}
```

---

## Testing Plan

### Unit Tests
- [ ] Codemap generator (each language parser)
- [ ] Change analyzer (various scenarios)
- [ ] System detection heuristics
- [ ] Manifest read/write

### Integration Tests
- [ ] Full build on sample repo
- [ ] Incremental update after changes
- [ ] New system detection
- [ ] Synthesis deduplication

### E2E Tests
- [ ] Install script
- [ ] Git hook flow
- [ ] Claude integration (mock or real)

---

## Migration Path

For repos with existing AGENTS.md files:

1. `context-layer init --existing`
   - Detects existing AGENTS.md files
   - Adds codemap markers
   - Creates manifest from existing structure
   - Preserves all curated content

2. First synthesis
   - Validates hierarchy
   - Checks for duplicates
   - Suggests cleanup

---

## Open Questions

1. **Nightly synthesis**: How to trigger? Cron job? GitHub Action schedule?
2. **Cost controls**: Max tokens per commit? Budget alerts?
3. **Multi-language repos**: Priority for which parsers to build first?
4. **Monorepo support**: Multiple manifests or one global?
5. **Conflict resolution**: What if manual edit conflicts with auto-update?

---

## Success Metrics

- **Zero manual maintenance calls** after initial setup
- **< 5 second** codemap update per commit
- **< $2/month** LLM costs for active repo
- **> 90% coverage** of significant systems
- **< 1 day staleness** for curated content after changes

---

## Timeline Estimate

| Phase | Effort | Dependencies |
|-------|--------|--------------|
| Phase 0 (current) | Done | - |
| Phase 1 (CLI) | 8-12 hours | - |
| Phase 2 (Git Hook) | 2-3 hours | Phase 1 |
| Phase 3 (Agent Updates) | 4-6 hours | Phase 1 |
| Phase 4 (Auto-maintenance) | 3-4 hours | Phase 2, 3 |
| Phase 5 (Polish) | 4-6 hours | Phase 4 |

**Total: ~25-35 hours**

---

## Next Steps

1. Push current changes to GitHub
2. Start Phase 1: Create CLI package structure
3. Implement tree-sitter TypeScript parser first (most common)
4. Test codemap generation on scribble repo

