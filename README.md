# Context Layer

**Self-updating documentation that gives AI agents the architectural knowledge they need to work effectively on large codebases.**

[![License: MIT](https://img.shields.io/badge/License-MIT-green.svg)](LICENSE)

> **Inspired by**: [The Intent Layer](https://www.intent-systems.com/learn/intent-layer) by Tyler Brandt at Intent Systems

---

## The Problem

The ceiling on AI results isn't model intelligenceâ€”it's what the model sees before it acts.

Your best engineers carry mental models: what each subsystem owns, what must never happen, where the real boundaries live. That knowledge accumulated over years of bugs, outages, and code reviews. It lives in heads and scattered docs, not in code.

When agents work on your codebase, they start from zero. Every request is a full onboardingâ€”not just to your task, but to your entire system. On large codebases, agents can't fit everything into context. They fumble in the dark, learning only by what they bump into.

## The Solution

**Context Layer** creates hierarchical `AGENTS.md` files throughout your codebase that:

1. **Auto-update on every commit** â€” No manual maintenance required
2. **Combine two types of knowledge**:
   - **Codemaps** â€” Auto-generated API surface using tree-sitter (free, instant)
   - **Curated content** â€” LLM-written ownership, invariants, and boundaries

```markdown
# AuthService

<!-- CODEMAP START - Auto-generated, do not edit -->
## API Surface
- `function authenticate(token: string): User`
- `function validateSession(sessionId: string): boolean`
- `function logout(userId: string): void`
<!-- CODEMAP END -->

---

## Ownership
**Owns**: User sessions, authentication state, token validation
**Does NOT own**: User data, permissions, account management

## Invariants
- Sessions expire after 24 hours
- Never store plain-text passwords
- All tokens must be validated before use
```

---

## Quick Start

### Install

```bash
curl -sSL https://raw.githubusercontent.com/MitchForest/context-layer/main/install/install.sh | bash
```

This installs:
- **4 agents** to `.claude/agents/` (Coordinator, Capture, Maintain, Synthesis)
- **1 skill** to `.claude/skills/` (entry point for Claude Code)
- **CLI tool** (generates codemaps, installs git hook)

### Initial Build

In Claude Code:

```
> Build context layer for src/
```

The coordinator discovers systems, spawns capture agents in parallel, and runs synthesis.

### What You Get

```
your-project/
â”œâ”€â”€ .context-layer/
â”‚   â””â”€â”€ manifest.json          # Systems registry
â”‚
â”œâ”€â”€ AGENTS.md                  # Root node
â”œâ”€â”€ CLAUDE.md â†’ AGENTS.md      # Symlink for Claude Code
â”‚
â””â”€â”€ src/
    â”œâ”€â”€ AGENTS.md              # Parent node
    â”‚
    â”œâ”€â”€ auth/
    â”‚   â””â”€â”€ AGENTS.md          # Codemap + curated content
    â”‚
    â”œâ”€â”€ api/
    â”‚   â””â”€â”€ AGENTS.md
    â”‚
    â””â”€â”€ database/
        â””â”€â”€ AGENTS.md
```

### Auto-Maintenance

After initial build, your context layer updates itself on every commit:

```
$ git commit -m "Add new feature"

ğŸ§  Context Layer: Processing commit...
   âœ“ Codemaps updated
   â†’ Changes detected, updating curated content with haiku...
   âœ“ Updated src/auth/AGENTS.md
```

**No manual intervention.** The git hook:
1. Regenerates codemaps using tree-sitter (instant, free)
2. Analyzes changes to determine if curated content needs updating
3. Runs Haiku to update curated content automatically

**To use Opus instead of Haiku:**
```bash
export CONTEXT_LAYER_MODEL=opus
```

---

## How It Works

### Two-Part AGENTS.md Structure

Every AGENTS.md file has two sections:

| Section | Generated By | Updated |
|---------|--------------|---------|
| **Codemap** | CLI (tree-sitter) | Every commit (automatic) |
| **Curated content** | LLM (Haiku/Opus) | When changes detected (automatic) |

The codemap provides the API surface. The curated content provides what code can't express: ownership, invariants, boundaries.

### Supported Languages

| Language | Codemap Support |
|----------|----------------|
| TypeScript/TSX | âœ… |
| JavaScript/JSX | âœ… |
| Python | âœ… |
| Swift | âœ… |

### Subagent Architecture

Context Layer uses specialized subagents for the initial build:

```
User: "Build context layer for src/"
                    â”‚
                    â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   COORDINATOR                 â”‚
    â”‚   â€¢ Discovers "systems"       â”‚
    â”‚   â€¢ Creates manifest          â”‚
    â”‚   â€¢ Spawns capture agents     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â–¼                       â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ CAPTURE â”‚    ...    â”‚ CAPTURE â”‚  â† Parallel, separate contexts
    â”‚ System1 â”‚           â”‚ SystemN â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   SYNTHESIS                   â”‚
    â”‚   â€¢ Deduplicates to LCA       â”‚
    â”‚   â€¢ Creates parent nodes      â”‚
    â”‚   â€¢ Adds downlinks            â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Hierarchical Loading

When an agent works in a directory, it automatically loads:
1. The root `AGENTS.md`
2. All ancestor nodes up to the working directory
3. The node covering the current directory

This gives agents a **T-shaped view**: broad context at the top, specific detail where they're working.

### LCA Optimization

Shared knowledge is automatically deduplicated to the **Least Common Ancestor**:

```
Before: Same fact in 3 leaf nodes (wasteful)
After:  Fact moved to parent node (loads once)
```

---

## CLI Commands

| Command | What It Does |
|---------|--------------|
| `context-layer init` | Initialize project, install git hook |
| `context-layer codemap [path]` | Generate API surface using tree-sitter |
| `context-layer status` | Show coverage and what's documented |
| `context-layer analyze` | Analyze changes since last commit |

---

## Compatibility

### Building the Context Layer

**Requires Claude Code.** The subagent architecture (Coordinator â†’ Capture â†’ Synthesis) uses Claude Code's agent spawning capabilities.

### Using the Context Layer

Once built, the `AGENTS.md` files work with **any AI tool** that loads context files:

- âœ… Claude Code (loads `CLAUDE.md` automatically)
- âœ… OpenAI Codex (loads `AGENTS.md` automatically)  
- âœ… Cursor (loads `AGENTS.md` from project directories)
- âœ… GitHub Copilot
- âœ… Windsurf
- âœ… Amp
- âœ… Goose

---

## File Convention

| File | Purpose | Tool Support |
|------|---------|--------------|
| `AGENTS.md` | Primary context file | Codex, most tools |
| `CLAUDE.md` | Symlink to AGENTS.md | Claude Code |

The installer creates symlinks automatically. To create one manually:

```bash
ln -s AGENTS.md CLAUDE.md
```

---

## Philosophy

Context Layer is inspired by Tyler Brandt's excellent article [The Intent Layer](https://www.intent-systems.com/learn/intent-layer) from Intent Systems. The core ideas:

1. **Compress context**: Distill large areas into minimal, high-signal tokens
2. **Surface hidden knowledge**: Capture what code can't express
3. **Self-maintaining**: Auto-update on every commit
4. **Least Common Ancestor**: Shared knowledge lives at the shallowest covering node

---

## Contributing

Contributions welcome! See [CONTRIBUTING.md](CONTRIBUTING.md).

## License

MIT Â© [Context Layer Contributors](LICENSE)
